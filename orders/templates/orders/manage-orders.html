{% extends 'base/base.html' %}

{% load crispy_forms_tags %}

{% load template_tags %}

{%block title %} Orders {%endblock%}

{% block breadcrumbs %}
<style>
    .text-wrap {
        word-wrap: break-word;
        white-space: pre-wrap;    }
</style>

<li>
    <div class="flex items-center">
        <svg aria-hidden="true" class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"
             xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd"></path>
        </svg>
        <a href="{% url 'orders:manage_orders' %}"
           class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2 dark:text-gray-400 dark:hover:text-white">Orders</a>
    </div>
</li>

<br>

{% endblock %}

{% block content %}
<h4 class="mb-4 text-lg font-semibold text-gray-600 dark:text-gray-300">Products List</h4>
<form method="get" class="mb-4 flex flex-wrap items-center gap-4">
    <input type="text" name="order_no" class="px-3 py-2 border rounded-md" placeholder="Search by Order No" value="{{ order_no }}">
    <input type="text" name="payment_id" class="px-3 py-2 border rounded-md" placeholder="Search by Payment ID" value="{{ payment_id }}">
    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">Search</button>
    <!-- Reset Button (Fixed) -->
     <a href="{% url 'orders:manage_orders' %}">
        <button type="button" class="px-4 py-2 bg-gray-300 text-black rounded-md">Reset</button>
    </a>
</form>
<div class="text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:text-gray-400 dark:border-gray-700">
    <ul class="flex flex-wrap -mb-px">
        <li class="mr-2">
            <a href="?status=ALL&order_no={{ order_no }}&payment_id={{ payment_id }}"
               class="inline-block p-4 {% if status == 'ALL' or not status %} text-blue-600 border-b-2 border-blue-600 {% else %} border-transparent hover:text-gray-600 hover:border-gray-300 {% endif %} rounded-t-lg">
               All Orders
            </a>
        </li>
        <li class="mr-2">
            <a href="?status=DELIVERED&order_no={{ order_no }}&payment_id={{ payment_id }}"
               class="inline-block p-4 {% if status == 'DELIVERED' %} text-blue-600 border-b-2 border-blue-600 {% else %} border-transparent hover:text-gray-600 hover:border-gray-300 {% endif %} rounded-t-lg">
               Order Delivered
            </a>
        </li>
        <li class="mr-2">
            <a href="?status=RECEIVED&order_no={{ order_no }}&payment_id={{ payment_id }}"
               class="inline-block p-4 {% if status == 'RECEIVED' %} text-blue-600 border-b-2 border-blue-600 {% else %} border-transparent hover:text-gray-600 hover:border-gray-300 {% endif %} rounded-t-lg">
               Order Received
            </a>
        </li>
        <li class="mr-2">
            <a href="?status=REFUND&order_no={{ order_no }}&payment_id={{ payment_id }}"
               class="inline-block p-4 {% if status == 'REFUND' %} text-blue-600 border-b-2 border-blue-600 {% else %} border-transparent hover:text-gray-600 hover:border-gray-300 {% endif %} rounded-t-lg">
               Apply for Refund
            </a>
        </li>
        <li class="mr-2">
            <a href="?status=PAYMENT_SUCCESS&order_no={{ order_no }}&payment_id={{ payment_id }}"
               class="inline-block p-4 {% if status == 'PAYMENT_SUCCESS' %} text-blue-600 border-b-2 border-blue-600 {% else %} border-transparent hover:text-gray-600 hover:border-gray-300 {% endif %} rounded-t-lg">
               Payment Success
            </a>
        </li>
        <li class="mr-2">
            <a href="?status=PAYMENT_FAILED&order_no={{ order_no }}&payment_id={{ payment_id }}"
               class="inline-block p-4 {% if status == 'PAYMENT_FAILED' %} text-blue-600 border-b-2 border-blue-600 {% else %} border-transparent hover:text-gray-600 hover:border-gray-300 {% endif %} rounded-t-lg">
               Payment Failed
            </a>
        </li>
    </ul>
</div>
<div class="w-full overflow-hidden rounded-lg shadow-xs">
    <div class="w-full overflow-x-auto">
        <table class="w-full whitespace-no-wrap">
            <thead>
            <tr class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase border-b dark:border-gray-700 bg-gray-50 dark:text-gray-400 dark:bg-gray-800">
                <th class="px-4 py-3">Order No</th>
                <th class="px-4 py-3">Customer Name</th>
                <th class="px-4 py-3">Applied Coupon</th>
                <th class="px-4 py-3">Order Date</th>
                <th class="px-4 py-3">Payment ID</th>
                <th class="px-4 py-3">Order Amount</th>
                <th class="px-4 py-3">Order Status</th>
                <th class="px-4 py-3">Payment Status</th>
                <th class="px-4 py-3">Created</th>
                <th class="px-4 py-3">Updated</th>
                <th class="px-4 py-3">Actions</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y dark:divide-gray-700 dark:bg-gray-800">
            {% if page_obj %}
            {% for order in page_obj %}
            <tr class="text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer"
                onclick="toggleRow('{{ forloop.counter }}')">
                <td class="px-4 py-3 text-sm">
                    {{ order }}
                </td>

                <td class="px-4 py-3 text-sm">
                    {{ order.user.first_name }} {{ order.user.last_name }}
                </td>
                <td class="px-4 py-3 text-sm">
                    {{ order.coupon }}
                </td>
                <td class="px-4 py-3 text-sm">
                    {{ order.ordered_date }}
                </td>
                <td class="px-4 py-3 text-sm">
                    {% with transactions=transaction|get_item:order.order_id %}
                    {% if transactions %}
                    {% for transaction in transactions %}
                    {{ transaction.razorpay_payment_id }}<br>
                    {% endfor %}
                    {% else %}
                    No transactions
                    {% endif %}
                    {% endwith %}
                </td>
                <td class="px-4 py-3 text-sm">
                    {{ order.get_total }}
                </td>
                <td class="px-4 py-3 text-sm">
                    {% if order.order_status == 'DELIVERED' %}
                    <span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">
                        Order has been Delivered
                </span>
                    {% endif %}
                    {% if order.order_status == 'RECEIVED' %}
                    <span class="px-2 py-1 font-semibold leading-tight text-yellow-700 bg-yellow-100 rounded-full dark:text-yellow-100 dark:bg-yellow-700">
                      Order Request Received
                </span>
                    {% endif %}
                    {% if order.order_status == 'REFUND' %}
                    <span class="px-2 py-1 font-semibold leading-tight text-red-700 bg-red-100 rounded-full dark:text-red-100 dark:bg-red-700">
                      Apply for Refund
                </span>
                    {% endif %}
                    {% if order.order_status == 'GRANTED' %}
                    <span class="px-2 py-1 font-semibold leading-tight text-purple-700 bg-purple-100 rounded-full dark:text-purple-100 dark:bg-purple-700">
                      Order Refund Granted
                    </span>
                    {% endif %}
                    {% if order.order_status == 'UPDATE' %}
                    <span class="px-2 py-1 font-semibold leading-tight text-purple-700 bg-purple-100 rounded-full dark:text-purple-100 dark:bg-purple-700">
                      Order Status Will Be Update Soon
                    </span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm">
                    {% with transactions=transaction|get_item:order.order_id %}
                    {% if transactions %}
                    {% for transaction in transactions %}
                    {% if transaction.payment_status == '1'%}
                    <span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-red-100 rounded-full dark:text-green-100 dark:bg-green-700">
                      Success
                    </span>
                    {% endif %}
                    {% if transaction.payment_status == '2'%}
                    <span class="px-2 py-1 font-semibold leading-tight text-red-700 bg-red-100 rounded-full dark:text-red-100 dark:bg-red-700">
                      Failed
                    </span>
                    {% endif %}
                    {% if transaction.payment_status == '3'%}
                    <span class="px-2 py-1 font-semibold leading-tight text-yellow-700 bg-yellow-100 rounded-full dark:text-yellow-100 dark:bg-yellow-700">
                      Pending
                    </span>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    No transactions
                    {% endif %}
                    {% endwith %}

                </td>
                <td class="px-4 py-3 text-sm">
                    {{ order.created_at }}
                </td>
                <td class="px-4 py-3 text-sm">
                    {{ order.updated_at }}
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center space-x-4 text-sm">
                        <a href="{% url 'orders:order_status' order.order_id %}">
                            <button
                                    class="flex items-center justify-between px-2 py-2 text-sm font-medium leading-5 text-purple-600 rounded-lg dark:text-gray-400 focus:outline-none focus:shadow-outline-gray"
                                    aria-label="Edit"
                            >
                                <svg
                                        class="w-5 h-5"
                                        aria-hidden="true"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                >
                                    <path
                                            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
                                    ></path>
                                </svg>
                            </button>
                        </a>
                        <a href="{% url 'orders:generate_invoice' order.order_id  %}">
                            <button
                                    class="flex items-center justify-between px-2 py-2 text-sm font-medium leading-5 text-purple-600 rounded-lg dark:text-gray-400 focus:outline-none focus:shadow-outline-gray"
                                    aria-label="Edit"
                            >
                                <i class="fa-solid fa-print"></i>
                            </button>
                        </a>
                    </div>
                </td>
            </tr>
            <tr id="details-{{ forloop.counter }}" class="hidden">
                <td colspan="9" class="px-4 py-3 bg-gray-50 dark:bg-gray-800">
                    <h4 class="font-semibold text-gray-600 dark:text-gray-300">Order Items :</h4>
                    <table class="w-full mt-2 table-auto border-collapse border border-gray-200 dark:border-gray-600">
                        <thead>
                        <tr class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-400">
                            <th class="px-4 py-2 border border-gray-300 dark:border-gray-600">Product</th>
                            <th class="px-4 py-2 border border-gray-300 dark:border-gray-600">Quantity</th>
                            <th class="px-4 py-2 border border-gray-300 dark:border-gray-600">Price</th>
                        </tr>
                        </thead>
                        <tbody class="text-sm text-gray-700 dark:text-gray-400">
                        {% if order %}
                        {% for item in order.order_items.all %}
                        <tr>
                            <td class="px-4 py-2 border border-gray-300 dark:border-gray-600">{{ item.product }}</td>
                            <td class="px-4 py-2 border border-gray-300 dark:border-gray-600">{{ item.quantity }}</td>
                            <td class="px-4 py-2 border border-gray-300 dark:border-gray-600">{{ item.product.discount_price }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-4 py-3 text-center">No Record Found</td>
                        </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="9" class="text-center">No Records Found</td>
            </tr>
            {% endif %}
            </tbody>

        </table>
    </div>
    <div class="grid px-4 py-3 text-xs font-semibold tracking-wide text-gray-500 uppercase border-t dark:border-gray-700 bg-gray-50 sm:grid-cols-9 dark:text-gray-400 dark:bg-gray-800">
        <span class="flex items-center col-span-3">
          Showing 21-30 of 100
        </span>
        <span class="col-span-2"></span>
        <!-- Pagination -->
        <span class="flex col-span-4 mt-2 sm:mt-auto sm:justify-end">
            <nav aria-label="Table navigation">
              <ul class="inline-flex items-center">
                  {% if page_obj.has_previous %}
                <li>
                  <a href="?page={{ page_obj.previous_page_number }}"
                     class="px-3 py-2 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Previous</a>
                </li>
                  {% endif %}
                  {% for i in page_obj.paginator.page_range%}
                  {% if page_obj.number == i %}
                <li>
                  <a href="?page={{i}}"
                     class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">{{i}}</a>
                </li>
                  {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'1' %}
                <li>
                  <a href="?page={{i}}"
                     class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">{{i}}</a>
                </li>
                  {% endif %}
                  {% endfor %}
                  {% if page_obj.paginator.num_pages > page_obj.number|add:'1' %}
                  <li><a href="?page={{ page_obj.number|add:'1' }}"></a></li>
                  {% endif %}
                  {% if page_obj.has_next %}
                <li>
                  <a href="?page={{ page_obj.next_page_number }}"
                     class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Next</a>
                </li>
                  {% endif %}
              </ul>
            </nav>
        </span>
    </div>

</div>

{% endblock%}

{%block js%}
<script>
    function toggleRow(id) {
        const detailsRow = document.getElementById(`details-${id}`);
        console.log(detailsRow);
        if (detailsRow.classList.contains('hidden')) {
            detailsRow.classList.remove('hidden');
        } else {
            detailsRow.classList.add('hidden');
        }
    }
</script>


{% endblock %}
